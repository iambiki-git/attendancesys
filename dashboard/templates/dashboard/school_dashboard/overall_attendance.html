{% extends "dashboard/base.html" %}
{% block content %}
<div class="container mx-auto px-4 py-8 max-w-7xl">
  <!-- Header with Action -->
  <div class="flex flex-col sm:flex-row justify-between items-start sm:items-center mb-8">
    <div>
      <h1 class="text-2xl font-normal text-gray-800">Attendance Overview</h1>
      <p class="text-gray-500 mt-1">Track and analyze student attendance patterns</p>
    </div>
    <button class="mt-4 sm:mt-0 bg-white border border-blue-500 text-blue-500 px-5 py-2.5 rounded-lg hover:bg-blue-50 transition-colors flex items-center">
      <svg xmlns="http://www.w3.org/2000/svg" class="h-4 w-4 mr-2" viewBox="0 0 20 20" fill="currentColor">
        <path fill-rule="evenodd" d="M10 3a1 1 0 011 1v5h5a1 1 0 110 2h-5v5a1 1 0 11-2 0v-5H4a1 1 0 110-2h5V4a1 1 0 011-1z" clip-rule="evenodd" />
      </svg>
      Record Attendance
    </button>
  </div>

  <!-- Smart Filter Bar -->
  <form method="get">
    <div class="bg-white rounded-xl p-4 mb-8 shadow-xs border border-gray-100">
      <div class="grid grid-cols-1 md:grid-cols-4 gap-3">
      <!-- Grade -->
        <div>
          <label class="block text-xs font-medium text-gray-500 mb-1">Grade</label>
          <select id="grade-select" name="grade"
                  class="w-full p-2.5 text-sm border border-gray-200 rounded-lg focus:ring-1 focus:ring-blue-200 focus:border-blue-300 bg-white">
            <option value="">All Grades</option>
            {% for grade in grades %}
              <option value="{{ grade.id }}" {% if grade.id|stringformat:"s" == selected_grade %}selected{% endif %}>
                {{ grade.grade_number }}
              </option>
            {% endfor %}
          </select>
        </div>
        <!-- Section Dropdown (dynamic) -->
          <div>
          <label class="block text-xs font-medium text-gray-500 mb-1">Section</label>
          <select id="section-select" name="section"
                  class="w-full p-2.5 text-sm border border-gray-200 rounded-lg focus:ring-1 focus:ring-blue-200 focus:border-blue-300 bg-white">
            <option value="">All Sections</option>
            {% for section in sections %}
              <option value="{{ section.id }}" {% if section.id|stringformat:"s" == selected_section %}selected{% endif %}>
                {{ section.name }}
              </option>
            {% endfor %}
          </select>
        </div>
        <!-- Date Range -->
        <div>
          <label class="block text-xs font-medium text-gray-500 mb-1">Date Range</label>
         <select id="date-range-select" name="date_range" class="...">
            <option value="today" {% if selected_range == "today" %}selected{% endif %}>Today</option>
            <option value="week" {% if selected_range == "week" %}selected{% endif %}>This Week</option>
            <option value="month" {% if selected_range == "month" or not selected_range %}selected{% endif %}>This Month</option>
            <option value="custom" {% if selected_range == "custom" %}selected{% endif %}>Custom Range</option>
          </select>

          <div id="custom-date-range" class="{% if selected_range != 'custom' %}hidden{% endif %} mt-2 md:col-span-2 grid grid-cols-1 md:grid-cols-2 gap-3">
  <div>
    <label class="block text-xs font-medium text-gray-500 mb-1">Start Date</label>
    <input type="date" name="start_date" value="{{ start_date|default:'' }}"
           class="w-full p-2.5 text-sm border border-gray-200 rounded-lg focus:ring-1 focus:ring-blue-200 focus:border-blue-300 bg-white">
  </div>
  <div>
    <label class="block text-xs font-medium text-gray-500 mb-1">End Date</label>
    <input type="date" name="end_date" value="{{ end_date|default:'' }}"
           class="w-full p-2.5 text-sm border border-gray-200 rounded-lg focus:ring-1 focus:ring-blue-200 focus:border-blue-300 bg-white">
  </div>
</div>

        </div>
        <!-- Apply Button -->
      <div class="flex items-end">
        <button type="submit"
                class="w-full bg-blue-500 text-white py-2.5 rounded-lg hover:bg-blue-600 transition-colors text-sm">
          Apply Filters
        </button>
      </div>
      </div>
    </div>
  </from>

  <!-- Insight Cards -->
  <div class="grid grid-cols-1 md:grid-cols-3 gap-5 mb-8">
    <div class="bg-white p-5 rounded-xl shadow-xs border border-gray-100 flex items-start">
      <div class="bg-blue-100 p-2 rounded-lg mr-4">
        <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5 text-blue-500" viewBox="0 0 20 20" fill="currentColor">
          <path fill-rule="evenodd" d="M10 18a8 8 0 100-16 8 8 0 000 16zm3.707-9.293a1 1 0 00-1.414-1.414L9 10.586 7.707 9.293a1 1 0 00-1.414 1.414l2 2a1 1 0 001.414 0l4-4z" clip-rule="evenodd" />
        </svg>
      </div>
      <div onclick="openDetails(this, 'present')"
          class="cursor-pointer"
          data-grade="{{ selected_grade }}"
          data-section="{{ selected_section }}"
          data-date-range="{{ selected_range }}"
          data-start-date="{{ start_date }}"
          data-end-date="{{ end_date }}">
          
        <div class="text-sm text-gray-500">
          Present Today <span class="font-bold text-xs">({{ present_count }})</span>
        </div>

        <div class="text-2xl font-light mt-1">
          {{ present_percent|floatformat:1|stringformat:"s"|slice:":-2" }}
          <span class="text-lg text-gray-400">
            {{ present_percent|floatformat:1|stringformat:"s"|slice:"-2:" }}%
          </span>
        </div>

        <div class="text-xs text-green-500 mt-1 flex items-center">
          <svg xmlns="http://www.w3.org/2000/svg" class="h-3 w-3 mr-0.5" viewBox="0 0 20 20" fill="currentColor">
            <path fill-rule="evenodd" d="M12 7a1 1 0 110-2h5a1 1 0 011 1v5a1 1 0 11-2 0V8.414l-4.293 4.293a1 1 0 01-1.414 0L8 10.414l-4.293 4.293a1 1 0 01-1.414-1.414l5-5a1 1 0 011.414 0L11 10.586 14.586 7H12z" clip-rule="evenodd" />
          </svg>
          2.3% from yesterday
        </div>
      </div>

    </div>
    <div class="bg-white p-5 rounded-xl shadow-xs border border-gray-100 flex items-start">
      <div class="bg-red-100 p-2 rounded-lg mr-4">
        <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5 text-red-500" viewBox="0 0 20 20" fill="currentColor">
          <path fill-rule="evenodd" d="M10 18a8 8 0 100-16 8 8 0 000 16zM8.707 7.293a1 1 0 00-1.414 1.414L8.586 10l-1.293 1.293a1 1 0 101.414 1.414L10 11.414l1.293 1.293a1 1 0 001.414-1.414L11.414 10l1.293-1.293a1 1 0 00-1.414-1.414L10 8.586 8.707 7.293z" clip-rule="evenodd" />
        </svg>
      </div>
      <div>
        <div class="text-sm text-gray-500">Absent Today <span class="font-bold text-xs">({{ absent_count }})</span></div>

        <div class="text-2xl font-light mt-1">
          {{ absent_percent|floatformat:1|stringformat:"s"|slice:":-2" }}
          <span class="text-lg text-gray-400">
            {{ absent_percent|floatformat:1|stringformat:"s"|slice:"-2:" }}%
          </span>
        </div>


        <div class="text-xs text-red-500 mt-1 flex items-center">
          <svg xmlns="http://www.w3.org/2000/svg" class="h-3 w-3 mr-0.5" viewBox="0 0 20 20" fill="currentColor">
            <path fill-rule="evenodd" d="M12 13a1 1 0 100 2h5a1 1 0 001-1v-5a1 1 0 10-2 0v2.586l-4.293-4.293a1 1 0 00-1.414 0L8 9.586l-4.293-4.293a1 1 0 00-1.414 1.414l5 5a1 1 0 001.414 0L11 9.414 14.586 13H12z" clip-rule="evenodd" />
          </svg>
          1.1% from yesterday
        </div>
      </div>
    </div>
    <div class="bg-white p-5 rounded-xl shadow-xs border border-gray-100 flex items-start">
      <div class="bg-yellow-100 p-2 rounded-lg mr-4">
        <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5 text-yellow-500" viewBox="0 0 20 20" fill="currentColor">
          <path fill-rule="evenodd" d="M10 18a8 8 0 100-16 8 8 0 000 16zm1-12a1 1 0 10-2 0v4a1 1 0 00.293.707l2.828 2.829a1 1 0 101.415-1.415L11 9.586V6z" clip-rule="evenodd" />
        </svg>
      </div>
      <div>
        <div class="text-sm text-gray-500">Late Arrivals <span class="font-bold text-xs">({{ late_count }})</span></div>

        <div class="text-2xl font-light mt-1">
          {{ late_percent|floatformat:1|stringformat:"s"|slice:":-2" }}
          <span class="text-lg text-gray-400">
            {{ late_percent|floatformat:1|stringformat:"s"|slice:"-2:" }}%
          </span>
        </div>


        <div class="text-xs text-yellow-500 mt-1 flex items-center">
          <svg xmlns="http://www.w3.org/2000/svg" class="h-3 w-3 mr-0.5" viewBox="0 0 20 20" fill="currentColor">
            <path fill-rule="evenodd" d="M12 7a1 1 0 110-2h5a1 1 0 011 1v5a1 1 0 11-2 0V8.414l-4.293 4.293a1 1 0 01-1.414 0L8 10.414l-4.293 4.293a1 1 0 01-1.414-1.414l5-5a1 1 0 011.414 0L11 10.586 14.586 7H12z" clip-rule="evenodd" />
          </svg>
          0.5% from yesterday
        </div>
      </div>
    </div>
  </div>

  <!-- Visual Data Section -->
  <div class="grid grid-cols-1 lg:grid-cols-2 gap-5 mb-8">
    <!-- Attendance Trend -->
    <div class="bg-white p-5 rounded-xl shadow-xs border border-gray-100">
      <div class="flex justify-between items-center mb-4">
        <h3 class="text-sm font-medium text-gray-700">Weekly Attendance Trend</h3>
        <div class="flex space-x-2">
          <button class="px-3 py-1 text-xs bg-blue-50 text-blue-500 rounded">Week</button>
          <button class="px-3 py-1 text-xs bg-white text-gray-500 rounded hover:bg-gray-50">Month</button>
        </div>
      </div>
      <div class="h-48">
        <!-- Chart placeholder with subtle grid lines -->
        <div class="h-full w-full bg-gray-50 rounded-lg flex items-end">
          <div class="flex-1 flex items-end space-x-1 px-2 pb-2">
            <div class="h-1/4 w-full bg-blue-100 rounded-t-sm"></div>
            <div class="h-1/2 w-full bg-blue-100 rounded-t-sm"></div>
            <div class="h-3/4 w-full bg-blue-100 rounded-t-sm"></div>
            <div class="h-full w-full bg-blue-500 rounded-t-sm"></div>
            <div class="h-2/3 w-full bg-blue-100 rounded-t-sm"></div>
            <div class="h-1/2 w-full bg-blue-100 rounded-t-sm"></div>
            <div class="h-3/5 w-full bg-blue-100 rounded-t-sm"></div>
          </div>
        </div>
        <div class="flex justify-between text-xs text-gray-400 mt-1 px-2">
          <span>Mon</span>
          <span>Tue</span>
          <span>Wed</span>
          <span>Thu</span>
          <span>Fri</span>
          <span>Sat</span>
          <span>Sun</span>
        </div>
      </div>
    </div>
    
    <!-- Class Distribution -->
    <div class="bg-white p-5 rounded-xl shadow-xs border border-gray-100">
      <div class="flex justify-between items-center mb-4">
        <h3 class="text-sm font-medium text-gray-700">Class Distribution</h3>
        <select class="text-xs p-1.5 border border-gray-200 rounded focus:ring-1 focus:ring-blue-200 bg-white">
          <option>By Present</option>
          <option>By Absent</option>
        </select>
      </div>
      <div class="h-48 flex items-center">
        <!-- Donut chart placeholder -->
        <div class="relative w-32 h-32 mx-auto">
          <div class="absolute inset-0 rounded-full border-8 border-blue-400"></div>
          <div class="absolute inset-0 rounded-full border-8 border-green-400" style="clip-path: polygon(0 0, 50% 0, 50% 100%, 0 100%);"></div>
          <div class="absolute inset-0 rounded-full border-8 border-yellow-400" style="clip-path: polygon(50% 0, 100% 0, 100% 100%, 50% 100%);"></div>
          <div class="absolute inset-0 flex items-center justify-center">
            <div class="text-xl font-light">92%</div>
          </div>
        </div>
        <div class="ml-8">
          <div class="flex items-center mb-2">
            <div class="w-3 h-3 rounded-full bg-blue-400 mr-2"></div>
            <span class="text-xs text-gray-600">Grade 5 (42%)</span>
          </div>
          <div class="flex items-center mb-2">
            <div class="w-3 h-3 rounded-full bg-green-400 mr-2"></div>
            <span class="text-xs text-gray-600">Grade 4 (35%)</span>
          </div>
          <div class="flex items-center">
            <div class="w-3 h-3 rounded-full bg-yellow-400 mr-2"></div>
            <span class="text-xs text-gray-600">Grade 3 (23%)</span>
          </div>
        </div>
      </div>
    </div>
  </div>

  <!-- Recent Attendance Table -->
  <div class="bg-white rounded-xl shadow-xs border border-gray-100 overflow-hidden">
    <div class="px-5 py-4 border-b border-gray-100 flex justify-between items-center">
      <h3 class="text-sm font-medium text-gray-700">Recent Attendance Records</h3>
      <button class="text-xs text-blue-500 hover:text-blue-700 flex items-center">
        View All
        <svg xmlns="http://www.w3.org/2000/svg" class="h-3 w-3 ml-1" viewBox="0 0 20 20" fill="currentColor">
          <path fill-rule="evenodd" d="M7.293 14.707a1 1 0 010-1.414L10.586 10 7.293 6.707a1 1 0 011.414-1.414l4 4a1 1 0 010 1.414l-4 4a1 1 0 01-1.414 0z" clip-rule="evenodd" />
        </svg>
      </button>
    </div>
    <div class="overflow-x-auto">
      <table class="min-w-full divide-y divide-gray-100">
        <thead>
          <tr>
            <th class="px-5 py-3 text-left text-xs font-medium text-gray-500">Date</th>
            <th class="px-5 py-3 text-left text-xs font-medium text-gray-500">Class</th>
            <th class="px-5 py-3 text-left text-xs font-medium text-gray-500">Teacher</th>
            <th class="px-5 py-3 text-left text-xs font-medium text-gray-500">Status</th>
            <th class="px-5 py-3 text-right text-xs font-medium text-gray-500"></th>
          </tr>
        </thead>
        <tbody class="divide-y divide-gray-100">
          <tr class="hover:bg-gray-50">
            <td class="px-5 py-4 whitespace-nowrap text-sm font-light">May 15, 2023</td>
            <td class="px-5 py-4 whitespace-nowrap text-sm font-light">Grade 5A</td>
            <td class="px-5 py-4 whitespace-nowrap text-sm font-light">Ms. Johnson</td>
            <td class="px-5 py-4 whitespace-nowrap">
              <span class="px-2 py-1 text-xs rounded-full bg-green-100 text-green-700">93% Present</span>
            </td>
            <td class="px-5 py-4 whitespace-nowrap text-right text-sm">
              <button class="text-blue-500 hover:text-blue-700 flex items-center justify-end w-full">
                Details
                <svg xmlns="http://www.w3.org/2000/svg" class="h-4 w-4 ml-1" viewBox="0 0 20 20" fill="currentColor">
                  <path fill-rule="evenodd" d="M7.293 14.707a1 1 0 010-1.414L10.586 10 7.293 6.707a1 1 0 011.414-1.414l4 4a1 1 0 010 1.414l-4 4a1 1 0 01-1.414 0z" clip-rule="evenodd" />
                </svg>
              </button>
            </td>
          </tr>
          <tr class="hover:bg-gray-50">
            <td class="px-5 py-4 whitespace-nowrap text-sm font-light">May 15, 2023</td>
            <td class="px-5 py-4 whitespace-nowrap text-sm font-light">Grade 5B</td>
            <td class="px-5 py-4 whitespace-nowrap text-sm font-light">Mr. Smith</td>
            <td class="px-5 py-4 whitespace-nowrap">
              <span class="px-2 py-1 text-xs rounded-full bg-yellow-100 text-yellow-700">84% Present</span>
            </td>
            <td class="px-5 py-4 whitespace-nowrap text-right text-sm">
              <button class="text-blue-500 hover:text-blue-700 flex items-center justify-end w-full">
                Details
                <svg xmlns="http://www.w3.org/2000/svg" class="h-4 w-4 ml-1" viewBox="0 0 20 20" fill="currentColor">
                  <path fill-rule="evenodd" d="M7.293 14.707a1 1 0 010-1.414L10.586 10 7.293 6.707a1 1 0 011.414-1.414l4 4a1 1 0 010 1.414l-4 4a1 1 0 01-1.414 0z" clip-rule="evenodd" />
                </svg>
              </button>
            </td>
          </tr>
          <tr class="hover:bg-gray-50">
            <td class="px-5 py-4 whitespace-nowrap text-sm font-light">May 14, 2023</td>
            <td class="px-5 py-4 whitespace-nowrap text-sm font-light">Grade 4A</td>
            <td class="px-5 py-4 whitespace-nowrap text-sm font-light">Ms. Williams</td>
            <td class="px-5 py-4 whitespace-nowrap">
              <span class="px-2 py-1 text-xs rounded-full bg-green-100 text-green-700">93% Present</span>
            </td>
            <td class="px-5 py-4 whitespace-nowrap text-right text-sm">
              <button class="text-blue-500 hover:text-blue-700 flex items-center justify-end w-full">
                Details
                <svg xmlns="http://www.w3.org/2000/svg" class="h-4 w-4 ml-1" viewBox="0 0 20 20" fill="currentColor">
                  <path fill-rule="evenodd" d="M7.293 14.707a1 1 0 010-1.414L10.586 10 7.293 6.707a1 1 0 011.414-1.414l4 4a1 1 0 010 1.414l-4 4a1 1 0 01-1.414 0z" clip-rule="evenodd" />
                </svg>
              </button>
            </td>
          </tr>
        </tbody>
      </table>
    </div>
  </div>
</div>

<div>
  {% if attendance_list %}
    <ul class="divide-y">
      {% for att in attendance_list %}
        <li class="py-2">
          <span class="font-medium">{{ att.student.first_name }} {{ att.student.last_name }}</span>
          <span class="text-sm text-gray-500">({{ att.date }})</span>
        </li>
      {% endfor %}
    </ul>
  {% else %}
    <p class="text-gray-500 text-sm">No students found for this filter.</p>
  {% endif %}
</div>

{% comment %} modal {% endcomment %}
<div id="attendance-modal" class="fixed inset-0 bg-black bg-opacity-40 hidden items-center justify-center z-50 flex">
  <div class="bg-white w-full max-w-lg rounded-xl shadow-lg p-6">
    <div class="flex justify-between items-center mb-4">
      <h2 id="modal-title" class="text-lg font-semibold text-gray-700">Details</h2>
      <button onclick="closeModal()" class="text-gray-400 hover:text-gray-700">&times;</button>
    </div>
    <div id="modal-content" class="text-sm text-gray-600">
      Loading...
    </div>
  </div>
</div>

<script>
  const sectionsByGrade = {{ sections_by_grade|safe }};
  const sectionSelect = document.getElementById("section-select");
  const gradeSelect = document.getElementById("grade-select");

  gradeSelect.addEventListener("change", function () {
    const selectedGradeId = this.value;
    sectionSelect.innerHTML = '<option value="">All Sections</option>'; // reset

    if (selectedGradeId && sectionsByGrade[selectedGradeId]) {
      sectionsByGrade[selectedGradeId].forEach(section => {
        const option = document.createElement("option");
        option.value = section.id;
        option.textContent = section.name;
        sectionSelect.appendChild(option);
      });
    }
  });



  // date range selector 
  const dateSelect = document.getElementById('date-range-select');
  const customDateDiv = document.getElementById('custom-date-range');

  dateSelect.addEventListener('change', function () {
    if (this.value === 'custom') {
      customDateDiv.classList.remove('hidden');
    } else {
      customDateDiv.classList.add('hidden');
    }
  });


  function openDetails(el, status) {
    console.log('status', status);
    const modal = document.getElementById("attendance-modal");
    const title = document.getElementById("modal-title");
    const content = document.getElementById("modal-content");

    modal.classList.remove("hidden");
    modal.classList.add("flex");

    title.textContent = `${status.charAt(0).toUpperCase() + status.slice(1)} Attendance Details`;

    const grade = el.dataset.grade;
    const section = el.dataset.section;
    const dateRange = el.dataset.dateRange;
    const startDate = el.dataset.startDate;
    const endDate = el.dataset.endDate;

    const params = new URLSearchParams({
      status,
      grade,
      section,
      date_range: dateRange,
      start_date: startDate,
      end_date: endDate
    });

    fetch("{% url 'attendance_details' %}?" + params.toString())
      .then(response => response.text())
      .then(data => {
        content.innerHTML = data;
      })
      .catch(() => {
        content.innerHTML = "Failed to load data.";
      });
  }


  function closeModal() {
    const modal = document.getElementById("attendance-modal");
    modal.classList.add("hidden");
    modal.classList.remove("flex");
  }

</script>


{% endblock %}