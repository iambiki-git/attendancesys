{% extends "dashboard/base.html" %}
{% block content %}
  <style>
    :root {
      --primary: #2ecc71;
      --secondary: #34495e;
      --bg: linear-gradient(to right, #e0f7fa, #f1f8e9);
      --white: #ffffff;
      --text: #2c3e50;
      --border: #d0d0d0;
      --accent: #16a085;
      --light-accent: #d1f2eb;
    }

    {% comment %} * {
      box-sizing: border-box;
      margin: 0;
      padding: 0;
    } {% endcomment %}

    {% comment %} body {
      font-family: 'Segoe UI', sans-serif;
      background: var(--bg);
      color: var(--text);
      padding: 2rem;
    } {% endcomment %}

    h2 {
      font-size: 2.5rem;
      margin-bottom: 1rem;
      text-align: center;
      color: var(--accent);
    }

    .controls {
      display: flex;
      flex-wrap: wrap;
      justify-content: center;
      align-items: center;
      gap: 1.5rem;
      margin-bottom: 2rem;
      background: #ffffff;
      padding: 1rem 2rem;
      border-radius: 12px;
      box-shadow: 0 5px 15px rgba(0, 0, 0, 0.05);
    }

    .controls label {
      font-size: 1rem;
      font-weight: 500;
      color: var(--secondary);
    }

    .controls input,
    .controls select {
      padding: 0.5rem 0.8rem;
      border: 1px solid var(--border);
      border-radius: 6px;
      font-size: 1rem;
      margin-left: 0.5rem;
    }

    .controls button {
      background: var(--primary);
      color: white;
      padding: 0.6rem 1.2rem;
      border: none;
      border-radius: 8px;
      font-weight: bold;
      font-size: 1rem;
      cursor: pointer;
      transition: background 0.3s;
    }

    .controls button:hover {
      background: #27ae60;
    }

    table {
      width: 100%;
      border-collapse: collapse;
      background: var(--white);
      border-radius: 12px;
      box-shadow: 0 10px 30px rgba(0, 0, 0, 0.08);
      margin-bottom: 2rem;
    }

    th, td {
      padding: 1rem;
      text-align: center;
      background: white;
      font-size: 1rem;
      border: 1px solid var(--border);
    }

    th {
      background: var(--light-accent);
      color: var(--accent);
      font-weight: bold;
      cursor: text;
    }

    td:hover {
      background: #f0fff5;
      cursor: pointer;
    }

    .input-popup {
      position: fixed;
      top: 50%;
      left: 50%;
      transform: translate(-50%, -50%);
      background: #ffffff;
      padding: 2rem;
      border-radius: 16px;
      box-shadow: 0 20px 40px rgba(0, 0, 0, 0.2);
      z-index: 1000;
      width: 300px;
    }

    .input-popup label {
      display: block;
      margin: 1rem 0 0.3rem;
      font-weight: 500;
      color: var(--secondary);
    }

    .input-popup select,
    .input-popup button {
      width: 100%;
      padding: 0.7rem;
      margin-top: 0.2rem;
      border: 1px solid #ccc;
      border-radius: 8px;
      font-size: 1rem;
    }

    .input-popup button {
      margin-top: 1rem;
      background: var(--primary);
      color: white;
      font-weight: 600;
      border: none;
      transition: background 0.3s;
    }

    .input-popup button:last-child {
      background: #e0e0e0;
      color: #333;
    }

    .input-popup button:hover {
      background: #27ae60;
    }

    .input-popup button:last-child:hover {
      background: #ccc;
    }

    .overlay {
      position: fixed;
      top: 0;
      left: 0;
      width: 100%;
      height: 100%;
      background: rgba(0, 0, 0, 0.3);
      z-index: 999;
    }

    @media (max-width: 600px) {
      .controls {
        flex-direction: column;
      }

      .input-popup {
        width: 90%;
      }

      th, td {
        padding: 0.6rem;
        font-size: 0.85rem;
      }
    }
  </style>


<h2>üìö Multi-Class Routine Builder</h2>

<div class="controls">
  <label>Grade:
  <select id="gradeSelect" name="grade_id" required>
    <option value="">-- Select Grade --</option>
    {% for grade in grades %}
      <option value="{{ grade.id }}">{{ grade.grade_number }}</option>
    {% endfor %}
  </select>
</label>

<label>Section:
  <select id="sectionSelect" name="section_id" required>
    <option value="">-- Select Section --</option>
  </select>
</label>

  <label>Periods:
    <input type="number" id="periodCount" min="1" max="10" value="8" />
  </label>
  <label>
    <input type="checkbox" id="autoReplicate" checked />
    Auto-replicate Monday ‚ûû All
  </label>
  <button onclick="renderTable()">Generate Routine</button>
</div>

<div id="tableContainer"></div>

<div class="overlay" id="overlay" style="display: none;"></div>
<div class="input-popup" id="popup" style="display: none;">
  <label>Subject:
    <select id="subjectInput">
      <option value="">select subject</option>
      {% if subjects %}
        {% for subject in subjects %}
          <option value="{{ subject.name }}">{{ subject.name }}</option>
        {% endfor %}
      {% endif %}
    </select>
  </label>
  <label>Teacher:
    <select id="teacherInput">
      <option value="">select teacher</option>
      {% if teachers %}
        {% for teacher in teachers %}
        <option value="{{ teacher.user.first_name }}">{{ teacher.user.first_name }} {{ teacher.user.last_name }}</option>
        {% endfor %}
      {% endif %}
    </select>
  </label>
  <button onclick="saveCell()">‚úÖ Save</button>
  <button onclick="closePopup()">‚ùå Cancel</button>
</div>

<script>
const days = ['Monday', 'Tuesday', 'Wednesday', 'Thursday', 'Friday'];
const tableContainer = document.getElementById('tableContainer');
let selectedCell = null;
let routineData = {};
let periodNames = {};

function getKey() {
  const grade = document.getElementById('gradeSelect').value;
  const section = document.getElementById('sectionSelect').value;
  return `${grade}-${section}`;
}

function checkTeacherConflict(teacher, day, period, currentKey) {
  for (const key in routineData) {
    if (key !== currentKey) {
      const dayData = routineData[key]?.[day];
      if (dayData?.[period]?.teacher === teacher) return true;
    }
  }
  return false;
}

function renderTable() {
  const grade = document.getElementById('gradeSelect').value;
  const section = document.getElementById('sectionSelect').value;
  if (!grade || !section) {
    alert('‚ö†Ô∏è Please select both Grade and Section before generating the routine.');
    return;
  }

  const count = parseInt(document.getElementById('periodCount').value);
  const key = getKey();

  if (!routineData[key]) routineData[key] = {};
  if (!periodNames[key]) {
  periodNames[key] = [];
}
for (let i = 0; i < count; i++) {
  if (!periodNames[key][i]) {
    periodNames[key][i] = `Period ${i + 1}`;
  }
}


  const currentData = routineData[key];

  const existing = document.getElementById(`routine-${key}`);
  if (existing) existing.remove();

  const wrapper = document.createElement('div');
  wrapper.id = `routine-${key}`;
  wrapper.style.marginBottom = '3rem';
  wrapper.innerHTML += `<h3 style="text-align:center;margin:1rem 0;">Routine: Grade ${key}</h3>`;

  const table = document.createElement('table');
  const thead = document.createElement('thead');
  const headRow = document.createElement('tr');

  const firstCol = document.createElement('th');
  firstCol.textContent = 'Day \\ Period';
  headRow.appendChild(firstCol);

  for (let i = 0; i < count; i++) {
    const th = document.createElement('th');
    th.contentEditable = true;
    th.textContent = periodNames[key][i];
    th.dataset.index = i;
    th.addEventListener('blur', () => {
      periodNames[key][i] = th.textContent.trim() || `Period ${i + 1}`;
    });
    th.addEventListener('keydown', e => {
      if (e.key === 'Enter') {
        e.preventDefault();
        th.blur();
      }
    });
    headRow.appendChild(th);
  }

  thead.appendChild(headRow);
  table.appendChild(thead);

  const tbody = document.createElement('tbody');
  days.forEach(day => {
    const tr = document.createElement('tr');
    tr.innerHTML = `<td><strong>${day}</strong></td>`;
    let p = 1;
    while (p <= count) {
      const entry = currentData[day]?.[p];
      const text = entry && entry.subject && entry.teacher ? `${entry.subject} (${entry.teacher})` : '';

      let span = 1;
      while (
        p + span <= count &&
        currentData[day]?.[p + span] &&
        currentData[day][p + span].subject === entry?.subject &&
        currentData[day][p + span].teacher === entry?.teacher
      ) {
        span++;
      }

      const td = document.createElement('td');
      td.colSpan = span;
      td.dataset.day = day;
      td.dataset.period = p;
      td.dataset.colspan = span;
      td.dataset.key = key;
      td.textContent = text;
      td.onclick = () => openPopup(td, span, currentData);
      tr.appendChild(td);

      p += span;
    }
    tbody.appendChild(tr);
  });

  table.appendChild(tbody);
  wrapper.appendChild(table);

  const saveBtn = document.createElement('button');
  saveBtn.textContent = 'üìÇ Save Routine';
  saveBtn.style.margin = '10px auto';
  saveBtn.style.display = 'block';
  saveBtn.style.padding = '0.7rem 1.5rem';
  saveBtn.style.fontSize = '1rem';
  saveBtn.style.backgroundColor = '#2ecc71';
  saveBtn.style.color = 'white';
  saveBtn.style.border = 'none';
  saveBtn.style.borderRadius = '8px';
  saveBtn.style.cursor = 'pointer';
  saveBtn.onclick = () => {
    alert(`Routine for ${key} saved ‚úÖ`);
  };

  wrapper.appendChild(saveBtn);
  tableContainer.appendChild(wrapper);
}

function openPopup(cell, colspan = 1, currentData) {
  selectedCell = { cell, colspan, currentData };
  const content = cell.textContent;
  const match = content.match(/^(.+?) \((.+?)\)$/);
  document.getElementById('subjectInput').value = match ? match[1] : '';
  document.getElementById('teacherInput').value = match ? match[2] : '';
  //document.getElementById('teacherInput').value = match ? match[2] : 'Mr. Sharma';
  document.getElementById('overlay').style.display = 'block';
  document.getElementById('popup').style.display = 'block';
}

function closePopup() {
  selectedCell = null;
  document.getElementById('overlay').style.display = 'none';
  document.getElementById('popup').style.display = 'none';
}

function saveCell() {
  const subject = document.getElementById('subjectInput').value;
  const teacher = document.getElementById('teacherInput').value;
  const { cell, colspan, currentData } = selectedCell;
  const day = cell.dataset.day;
  const periodStart = parseInt(cell.dataset.period);
  const key = cell.dataset.key;

  for (let i = 0; i < colspan; i++) {
    if (checkTeacherConflict(teacher, day, periodStart + i, key)) {
      alert(`‚ùå Teacher ${teacher} is already assigned at Period ${periodStart + i} on ${day} in another class.`);
      return;
    }
  }

  if (!routineData[key]) routineData[key] = {};
  if (!routineData[key][day]) routineData[key][day] = {};

  for (let i = 0; i < colspan; i++) {
    routineData[key][day][periodStart + i] = { subject, teacher };
  }

  const replicate = document.getElementById('autoReplicate')?.checked ?? true;
  if (replicate && day === 'Monday') {
    days.forEach(d => {
      if (d === 'Monday') return;
      if (!routineData[key][d]) routineData[key][d] = {};
      for (let i = 0; i < colspan; i++) {
        if (!checkTeacherConflict(teacher, d, periodStart + i, key)) {
          routineData[key][d][periodStart + i] = { subject, teacher };
        }
      }
    });
  }

  closePopup();
  renderTable(); // Refresh with updated data and merge cells
}



  // Get the sections data from Django context
  const sectionsByGrade = {{ sections_by_grade|safe }};

  const gradeSelect = document.getElementById("gradeSelect");
  const sectionSelect = document.getElementById("sectionSelect");

  gradeSelect.addEventListener("change", function () {
    const gradeId = this.value;

    // Clear existing options
    sectionSelect.innerHTML = '<option value="">-- Select Section --</option>';

    if (sectionsByGrade[gradeId]) {
      sectionsByGrade[gradeId].forEach(section => {
        const option = document.createElement("option");
        option.value = section.id;
        option.textContent = section.name;
        sectionSelect.appendChild(option);
      });
    }
  });
</script>

{% endblock %}